[tools]
age = "latest"
direnv = "latest"
flux2 = "latest"
k3d = "latest"
kubectl = "latest"
python = { version='3' }
sops = "latest"
uv = "latest"

[settings]
experimental = true
python.uv_venv_auto = true

[env]
# Use the project name derived from the current directory
PROJECT_NAME = "{{ config_root | basename }}"

# Automatic virtualenv activation
_.python.venv = { path = "/tmp/.venv-{{ env.PROJECT_NAME }}" , create = true }
LC_ALL = "en_US.UTF-8"
LC_CTYPE = "en_US.UTF-8"
DEFAULT_IFACE = "{{ exec(command='ip route | grep default | head -n 1 | cut -d \" \" -f 5') }}"
CURRENT_IP = "{{ exec(command='ip addr show ' ~ env.DEFAULT_IFACE ~ ' | grep inet | cut -d \"/\" -f 1 | cut -d \"t\" -f 2 | tr -d \" \" | head -n 1') }}"
CURRENT_EXTERNAL_IP = "{{ exec(command='curl -sSL ipinfo.io/ip') }}"
SECRET_KEY="{{ exec(command='python3 -c \"import os, base64; print(base64.b64encode(os.urandom(128)).decode())\"') }}"
# These secrets are loaded from .mise.local.toml to avoid repeated Bitwarden calls
# Run 'mise run fetch-secrets' to refresh the cached values
FLUX_GITHUB_APP_ID = ""
FLUX_GITHUB_APP_INSTALLATION_ID = ""
SHARED_PATH = "{{ env.HOME }}/projects"
CLUSTER_NAME = "logging"

[tasks.fetch-secrets]
description = "Fetch secrets from Bitwarden and cache them in .mise.local.toml"
run = '''
#!/bin/bash
rm .mise.local.toml 2>/dev/null || true
cat > .mise.local.toml << EOF
# Auto-generated by 'mise run fetch-secrets' - do not edit manually
# Re-run the task to refresh secrets from Bitwarden
[env]
FLUX_GITHUB_APP_ID = "$(bash get_secret.sh fluxpilot_AppID)"
FLUX_GITHUB_APP_INSTALLATION_ID = "$(bash get_secret.sh fluxpilot_AppInstallationID)"
EOF
echo "Secrets cached in .mise.local.toml"
'''

[tasks.cluster-setup]
description = "Setup Flux in the cluster"
alias = 'cs' # `mise run cs`
run = [
  "kubectl apply -k bootstrap",
]

[tasks.flux-secret]
description = "Create GitHub App secret for Flux"
depends = ["cluster-setup"]
alias = "fs"
run = [
  "kubectl create secret generic githubapp-auth --namespace=flux-system --from-file=githubAppPrivateKey=gihub-app-key.pem --from-literal=githubAppInstallationID=\"{{ env.FLUX_GITHUB_APP_INSTALLATION_ID }}\" --from-literal=githubAppID=\"{{ env.FLUX_GITHUB_APP_ID }}\" || true",
  "kubectl annotate secret githubapp-auth -n flux-system source.toolkit.fluxcd.io/provider=github --overwrite"
]

[tasks.cluster-kind-setup]
description = "Setup kind cluster with Flux"
depends = ["flux-secret"]
alias = "cks"
run = [
  "kubectl apply -k clusters/kind",
]

[tasks.cluster-k3s-setup]
depends = ["flux-secret"]
description = "Setup k3s cluster with Flux"
alias = "c3s"
run = [
  "kubectl apply -k clusters/k3s",
]

[tasks.sync]
description = "Sync local changes to the cluster"
alias = "s"
run = [
  "flux reconcile source git flux-system ; flux reconcile ks -n flux-system cluster --with-source"
]

[tasks.reset-cluster]
description = "Reset the cluster by deleting and recreating it"
alias = "rc"
run = [
  "kind delete cluster; kind create cluster",
]
