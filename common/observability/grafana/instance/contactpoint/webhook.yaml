apiVersion: v1
kind: Secret
metadata:
  name: contact-ntfy
stringData:
  ntfy-url: "https://ntfy.sh/myalerts"
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaContactPoint
metadata:
  name: grafana-ntfy-contact
spec:
  name: grafana-ntfy-contact
  type: "webhook"
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana
  settings:
    http_method: "POST"
    max_alerts: 0
  valuesFrom:
    - targetPath: url
      valueFrom:
        secretKeyRef:
          name: contact-ntfy
          key: ntfy-url
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaNotificationTemplate
metadata:
  name: ntfy-template
spec:
  name: ntfy-template
  editable: false
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana
  template: |
    {{ define "default.message" }}
    ðŸš¨ *{{ .Status | toUpper }}*: {{ .CommonLabels.alertname | default "Multiple alerts" }}

    {{ range .Alerts }}
    â–¶ *{{ .Labels.alertname }}* ({{ .Labels.severity | default "info" }})
       {{ .Annotations.summary | default "" }}
       {{ .Annotations.description | default "" }}
    {{ end }}

    Source: {{ .ExternalURL }}
    {{ end }}
---
apiVersion: grafana.integreatly.org/v1beta1
kind: GrafanaNotificationPolicy
metadata:
  name: ntfy-policy
spec:
  instanceSelector:
    matchLabels:
      grafana.internal/instance: grafana
  contactPoint:
    name: ntfy-contactpoint
  groupBy:
    - alertname
  policy:
    matcherRegex:
      - name: severity
        value: ".*"
    continue: false
  message:
    template: ntfy-template
